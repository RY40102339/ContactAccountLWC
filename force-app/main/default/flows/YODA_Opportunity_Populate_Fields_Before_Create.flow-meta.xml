<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>52.0</apiVersion>
    <assignments>
        <description>Assign BU, Region, Probability and Industry
Region - from Record&apos;s Owner region
Probability - As per Matrix
Industry - From Account&apos;s record
Business Unit - From User&apos;s BU</description>
        <name>Assign_Calculated_Values</name>
        <label>Assign Calculated Values</label>
        <locationX>182</locationX>
        <locationY>431</locationY>
        <assignmentItems>
            <assignToReference>$Record.Region__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Process_Region</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>$Record.Industry__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Process_Industry</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>$Record.Business_Unit__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Process_Business_Unit</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Product_RT</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Update_Probability</name>
        <label>Update Probability</label>
        <locationX>50</locationX>
        <locationY>671</locationY>
        <assignmentItems>
            <assignToReference>$Record.Probability</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Probability</elementReference>
            </value>
        </assignmentItems>
    </assignments>
    <decisions>
        <name>Bypass_flow_rules</name>
        <label>Bypass flow rules</label>
        <locationX>380</locationX>
        <locationY>311</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>bypass_false</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Setup.Bypass_Settings__c.Bypass_Flow_Rules__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_Calculated_Values</targetReference>
            </connector>
            <label>bypass false</label>
        </rules>
    </decisions>
    <decisions>
        <description>Update Probability only for Product record type.</description>
        <name>Product_RT</name>
        <label>Product RT</label>
        <locationX>182</locationX>
        <locationY>551</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Product_Probability</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Product</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Probability</targetReference>
            </connector>
            <label>Product Probability</label>
        </rules>
    </decisions>
    <description>Populate fields before Opportunity record is created. Industry, Region, Business Unit. 
Added Probability Matrix logic only for Product record type (Probability for Project and Recurring as OOTB. 9/9)
Added Bypass Check
Added BSU (10/1)</description>
    <formulas>
        <name>Probability</name>
        <dataType>Number</dataType>
        <expression>IF(
 ISPICKVAL({!$Record.StageName}, &apos;Identify (SAL)&apos;), 0,
IF(
 ISPICKVAL({!$Record.StageName}, &apos;Qualify(SQL)&apos;),
IF(
ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;&apos;), 0, 10
) ,
IF(
 ISPICKVAL({!$Record.StageName}, &apos;Develop&apos;), 
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Only Alternative&apos;), 50,
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Front Runner&apos;), 30,
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Shared&apos;), 20,
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Zero&apos;), 15, 0
)
)
)
),
IF(
 ISPICKVAL({!$Record.StageName}, &apos;Propose / Quote&apos;), 
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Only Alternative&apos;), 75,
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Front Runner&apos;), 50,
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Shared&apos;), 30,
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Zero&apos;), 20, 0
)
)
)
),
IF(
 ISPICKVAL({!$Record.StageName}, &apos;Negotiate&apos;), 
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Only Alternative&apos;), 90,
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Front Runner&apos;), 75,
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Shared&apos;), 50,
IF(
 ISPICKVAL({!$Record.Competition_Positioning__c}, &apos;Zero&apos;), 25, 0
)
)
)
),
IF(
 ISPICKVAL({!$Record.StageName}, &apos;Closed Won&apos;), 100, 0
)
)
)
)
)
)</expression>
        <scale>0</scale>
    </formulas>
    <formulas>
        <description>If user does not fill in Business Unit on Opportunity record, then use that user&apos;s Business Unit.</description>
        <name>Process_Business_Unit</name>
        <dataType>String</dataType>
        <expression>IF(
AND(
ISPICKVAL({!$Record.Business_Unit__c}, &quot;&quot;),
{!$Setup.Bypass_Settings__c.Bypass_Flow_Rules__c} = false
),
TEXT({!$User.Business_Unit__c}),TEXT({!$Record.Business_Unit__c})
)</expression>
    </formulas>
    <formulas>
        <name>Process_Industry</name>
        <dataType>String</dataType>
        <expression>IF(
AND(
{!$Record.Industry__c} = NULL,
{!$Setup.Bypass_Settings__c.Bypass_Flow_Rules__c} = false
),
{!$Record.End_User__r.Industry__c}, {!$Record.Industry__c} 
)</expression>
    </formulas>
    <formulas>
        <name>Process_Region</name>
        <dataType>String</dataType>
        <expression>IF(
AND(
{!$Record__Prior.Id} = NULL,
{!$Setup.Bypass_Settings__c.Bypass_Flow_Rules__c} = false
),
TEXT({!$Record.Region__c}),
TEXT({!$Record.Owner.Region__c})
)</expression>
    </formulas>
    <interviewLabel>YODA Opportunity Populate Fields Before Create {!$Flow.CurrentDateTime}</interviewLabel>
    <label>YODA Opportunity - Populate Fields Before Create</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <start>
        <locationX>254</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Bypass_flow_rules</targetReference>
        </connector>
        <object>Opportunity</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordBeforeSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>Errormessage</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
        <value>
            <stringValue>User is not allowed to create Opportunity.</stringValue>
        </value>
    </variables>
</Flow> 
